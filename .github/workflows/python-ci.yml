name: Python CI + Test PDF Report

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 🧾 Clonar el repositorio
      uses: actions/checkout@v3

    - name: 🐍 Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: 📦 Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        sudo apt-get install -y wkhtmltopdf

    - name: 📂 Agregar el proyecto al PYTHONPATH
      run: echo "PYTHONPATH=$PWD" >> $GITHUB_ENV

    - name: ✅ Ejecutar tests y generar HTML report
      run: |
        pytest --html=report.html --self-contained-html

    - name: 📄 Convertir HTML a PDF
      run: |
        python -c "import pdfkit; pdfkit.from_file('report.html', 'latest_test_report.pdf')"

    - name: 🚀 Subir PDF e index.html a gh-pages
      run: |
        # Configurar git
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"

        # Obtener rama gh-pages
        git fetch origin gh-pages || true
        git checkout -B gh-pages
        
        # Limpiar rama excepto .git
        find . -not -path './.git*' -delete

        # Crear estructura de directorios
        mkdir -p reports
        
        # Mover PDF
        mv ../latest_test_report.pdf reports/
        
        # Crear index.html que redirige al PDF
        echo '<!DOCTYPE html>
        <html>
        <head>
            <meta http-equiv="refresh" content="0; url=./reports/latest_test_report.pdf" />
            <title>Test Results</title>
        </head>
        <body>
            <p>Redirecting to <a href="./reports/latest_test_report.pdf">latest test report</a>...</p>
        </body>
        </html>' > index.html

        # Hacer commit y push
        git add .
        git commit -m "Update test report and index - $(date -u)" || echo "No changes to commit"
        git push origin gh-pages --force