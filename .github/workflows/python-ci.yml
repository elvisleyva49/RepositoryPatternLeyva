name: Python CI with PDF Deployment

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write  # Esto es crucial para poder hacer push

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para trabajar con m√∫ltiples ramas
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-html pytest-cov
        sudo apt-get install -y wkhtmltopdf
        
    - name: Run tests
      run: |
        PYTHONPATH=$PYTHONPATH:$GITHUB_WORKSPACE python -m pytest tests/ \
          --html=report.html \
          --self-contained-html \
          --cov=repository_pattern \
          --cov-report=html
    
    - name: Generate PDF report
      run: |
        wkhtmltopdf --enable-local-file-access report.html test_report.pdf
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: Deploy PDF to gh-pages
      run: |
        git fetch origin gh-pages || true
        git checkout -b gh-pages origin/gh-pages || git checkout --orphan gh-pages
        # Solo mantenemos los reports
        find . -not -path './reports*' -not -path './.git*' -delete
        mkdir -p reports
        cp test_report.pdf reports/latest_test_report.pdf
        git add reports/latest_test_report.pdf
        git commit -m "Update test report PDF - $(date +'%Y-%m-%d %H:%M:%S')"
        git push origin gh-pages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}